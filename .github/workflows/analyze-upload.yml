name: Analyze Uploaded Datalog

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]

jobs:
  analyze:
    runs-on: ubuntu-latest
    if: |
      contains(github.event.issue.body || github.event.comment.body, '.csv') ||
      contains(github.event.issue.title, 'datalog') ||
      contains(github.event.issue.title, 'analyze')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pandas requests

      - name: Extract and analyze datalog
        id: analyze
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const https = require('https');
            const http = require('http');
            const { execSync } = require('child_process');
            
            // Get the body text (from issue or comment)
            const body = context.payload.comment?.body || context.payload.issue?.body || '';
            
            // Find CSV attachment URLs (GitHub uploads)
            const csvPattern = /https:\/\/github\.com\/[^\s)]+\.csv/gi;
            const userContentPattern = /https:\/\/user-images\.githubusercontent\.com\/[^\s)]+/gi;
            const attachmentPattern = /https:\/\/github\.com\/user-attachments\/files\/[^\s)]+/gi;
            
            let urls = [];
            urls.push(...(body.match(csvPattern) || []));
            urls.push(...(body.match(attachmentPattern) || []));
            
            if (urls.length === 0) {
              console.log('No CSV attachments found in issue/comment');
              core.setOutput('found', 'false');
              return;
            }
            
            core.setOutput('found', 'true');
            
            // Download first CSV found
            const url = urls[0];
            console.log(`Downloading: ${url}`);
            
            const filename = 'uploaded_datalog.csv';
            
            // Use curl to download (handles redirects)
            try {
              execSync(`curl -L -o ${filename} "${url}"`, { stdio: 'inherit' });
            } catch (e) {
              core.setFailed(`Failed to download CSV: ${e.message}`);
              return;
            }
            
            // Verify it's a CSV
            const content = fs.readFileSync(filename, 'utf8');
            if (!content.includes(',') || content.length < 100) {
              core.setFailed('Downloaded file does not appear to be a valid CSV');
              return;
            }
            
            // Run analysis
            console.log('Running FA20 analysis...');
            let output;
            try {
              output = execSync(`python bin/fa20amp-analyze ${filename} 2>&1`, { 
                encoding: 'utf8',
                maxBuffer: 10 * 1024 * 1024
              });
            } catch (e) {
              output = e.stdout || e.message;
            }
            
            // Strip ANSI color codes for GitHub comment
            output = output.replace(/\x1b\[[0-9;]*m/g, '');
            
            core.setOutput('analysis', output);
            
            // Read JSON report if generated
            const jsonFile = 'uploaded_datalog_analysis.json';
            if (fs.existsSync(jsonFile)) {
              const report = JSON.parse(fs.readFileSync(jsonFile, 'utf8'));
              core.setOutput('issues_count', report.issues?.length || 0);
              core.setOutput('has_critical', report.issues?.some(i => i.severity === 'CRITICAL') || false);
            }

      - name: Post analysis results
        if: steps.analyze.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const analysis = `${{ steps.analyze.outputs.analysis }}`;
            const issuesCount = '${{ steps.analyze.outputs.issues_count }}';
            const hasCritical = '${{ steps.analyze.outputs.has_critical }}';
            
            let emoji = '‚úÖ';
            if (hasCritical === 'true') emoji = 'üö®';
            else if (parseInt(issuesCount) > 0) emoji = '‚ö†Ô∏è';
            
            const comment = `## ${emoji} FA20 Datalog Analysis Results

\`\`\`
${analysis}
\`\`\`

---
<sub>Analyzed by [FA20 Datalog Analyzer](https://github.com/${context.repo.owner}/${context.repo.repo})</sub>`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Post no-CSV message
        if: steps.analyze.outputs.found == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            // Only post if issue title suggests they wanted analysis
            const title = context.payload.issue?.title?.toLowerCase() || '';
            if (title.includes('datalog') || title.includes('analyze')) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `üëã To analyze your datalog, please attach a CSV file to this issue.\n\nDrag and drop your datalog CSV file into the comment box, or use the attachment button.`
              });
            }
